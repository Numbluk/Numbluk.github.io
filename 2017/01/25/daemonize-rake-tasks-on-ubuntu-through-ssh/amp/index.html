
<head>
    <meta charset="utf-8">

    <title>How to Daemonize Rake Tasks on Ubuntu Through SSH</title>
    <meta name="description" content="">

    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width,minimum-scale=1,initial-scale=1">

    <link rel="shortcut icon" href="../../../../../favicon.ico">

    <link rel="canonical" href="../index.html">
    <meta name="referrer" content="no-referrer-when-downgrade">
    
    <meta property="og:site_name" content="Lukas Nimmo">
    <meta property="og:type" content="article">
    <meta property="og:title" content="How to Daemonize Rake Tasks on Ubuntu Through SSH">
    <meta property="og:description" content="Daemons and Rake At some point in your web development journey you may find yourself wanting to execute something far away from you and your terminal (think remote server). More than likely, the first thing that will enter your mind is to execute the following: $ my_rake_task Easy right?">
    <meta property="og:url" content="http://localhost:2368/2017/01/25/daemonize-rake-tasks-on-ubuntu-through-ssh/">
    <meta property="article:published_time" content="2017-01-25T07:48:09.000Z">
    <meta property="article:modified_time" content="2017-01-25T22:00:47.000Z">
    <meta property="article:tag" content="Linux">
    <meta property="article:tag" content="Ruby">
    <meta property="article:tag" content="Rake">
    <meta property="article:tag" content="Rails">
    <meta property="article:tag" content="Daemons">
    
    <meta name="twitter:card" content="summary">
    <meta name="twitter:title" content="How to Daemonize Rake Tasks on Ubuntu Through SSH">
    <meta name="twitter:description" content="Daemons and Rake At some point in your web development journey you may find yourself wanting to execute something far away from you and your terminal (think remote server). More than likely, the first thing that will enter your mind is to execute the following: $ my_rake_task Easy right?">
    <meta name="twitter:url" content="http://localhost:2368/2017/01/25/daemonize-rake-tasks-on-ubuntu-through-ssh/">
    <meta name="twitter:label1" content="Written by">
    <meta name="twitter:data1" content="Lukas Nimmo">
    <meta name="twitter:label2" content="Filed under">
    <meta name="twitter:data2" content="Linux, Ruby, Rake, Rails, Daemons">
    
    <script type="application/ld+json">
{
    "@context": "https://schema.org",
    "@type": "Article",
    "publisher": {
        "@type": "Organization",
        "name": "Lukas Nimmo",
        "logo": "http://localhost:2368/ghost/img/ghosticon.jpg"
    },
    "author": {
        "@type": "Person",
        "name": "Lukas Nimmo",
        "image": {
            "@type": "ImageObject",
            "url": "//www.gravatar.com/avatar/fd080461b35c3dcb5911e38d5f58c5af?s=250&d=mm&r=x",
            "width": 250,
            "height": 250
        },
        "url": "http://localhost:2368/author/lukas/",
        "sameAs": [],
        "description": "I enjoy writing software and I constantly wish I was in the mountains."
    },
    "headline": "How to Daemonize Rake Tasks on Ubuntu Through SSH",
    "url": "http://localhost:2368/2017/01/25/daemonize-rake-tasks-on-ubuntu-through-ssh/",
    "datePublished": "2017-01-25T07:48:09.000Z",
    "dateModified": "2017-01-25T22:00:47.000Z",
    "keywords": "Linux, Ruby, Rake, Rails, Daemons",
    "description": "Daemons and Rake At some point in your web development journey you may find yourself wanting to execute something far away from you and your terminal (think remote server). More than likely, the first thing that will enter your mind is to execute the following: $ my_rake_task Easy right?",
    "mainEntityOfPage": {
        "@type": "WebPage",
        "@id": "http://localhost:2368"
    }
}
    </script>

    <meta name="generator" content="Ghost 0.11">
    <link rel="alternate" type="application/rss+xml" title="Lukas Nimmo" href="../../../../../rss/index.html">

    <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Merriweather:300,700,700italic,300italic%7COpen+Sans:700,600,400">
    <style amp-custom>
        /* ==========================================================================
           Table of Contents
           ========================================================================== */

        /*

            0. Normalize
            1. General
            2. Utilities
            3. AMP Post
            4. Footer

        */

        /* ==========================================================================
           0. normalize.css v3.0.3 | MIT License | git.io/normalize | (minified)
           ========================================================================== */

        html {
            font-family: sans-serif;

            -ms-text-size-adjust: 100%;
            -webkit-text-size-adjust: 100%;
        }
        body {
            margin: 0;
        }
        article,
        aside,
        details,
        figcaption,
        figure,
        footer,
        header,
        main,
        menu,
        nav,
        section,
        summary {
            display: block;
        }
        audio,
        canvas,
        progress,
        video {
            display: inline-block;
            vertical-align: baseline;
        }
        audio:not([controls]) {
            display: none;
            height: 0;
        }
        [hidden],
        template {
            display: none;
        }
        a {
            background-color: transparent;
        }
        a:active,
        a:hover {
            outline: 0;
        }
        abbr[title] {
            border-bottom: 1px dotted;
        }
        b,
        strong {
            font-weight: bold;
        }
        dfn {
            font-style: italic;
        }
        h1 {
            margin: 0.67em 0;
            font-size: 2em;
        }
        mark {
            background: #ff0;
            color: #000;
        }
        small {
            font-size: 80%;
        }
        sub,
        sup {
            position: relative;
            vertical-align: baseline;
            font-size: 75%;
            line-height: 0;
        }
        sup {
            top: -0.5em;
        }
        sub {
            bottom: -0.25em;
        }
        img {
            border: 0;
        }
        amp-img {
            border: 0;
        }
        svg:not(:root) {
            overflow: hidden;
        }
        figure {
            margin: 1em 40px;
        }
        hr {
            box-sizing: content-box;
            height: 0;
        }
        pre {
            overflow: auto;
        }
        code,
        kbd,
        pre,
        samp {
            font-family: monospace, monospace;
            font-size: 1em;
        }
        button,
        input,
        optgroup,
        select,
        textarea {
            margin: 0;
            color: inherit;
            font: inherit;
        }
        button {
            overflow: visible;
        }
        button,
        select {
            text-transform: none;
        }
        button,
        html input[type="button"],
        input[type="reset"],
        input[type="submit"] {
            cursor: pointer;

            -webkit-appearance: button;
        }
        button[disabled],
        html input[disabled] {
            cursor: default;
        }
        button::-moz-focus-inner,
        input::-moz-focus-inner {
            padding: 0;
            border: 0;
        }
        input {
            line-height: normal;
        }
        input[type="checkbox"],
        input[type="radio"] {
            box-sizing: border-box;
            padding: 0;
        }
        input[type="number"]::-webkit-inner-spin-button,
        input[type="number"]::-webkit-outer-spin-button {
            height: auto;
        }
        input[type="search"] {
            -webkit-appearance: textfield;
        }
        input[type="search"]::-webkit-search-cancel-button,
        input[type="search"]::-webkit-search-decoration {
            -webkit-appearance: none;
        }
        fieldset {
            margin: 0 2px;
            padding: 0.35em 0.625em 0.75em;
            border: 1px solid #c0c0c0;
        }
        legend {
            padding: 0;
            border: 0;
        }
        textarea {
            overflow: auto;
        }
        optgroup {
            font-weight: bold;
        }
        table {
            border-spacing: 0;
            border-collapse: collapse;
        }
        td,
        th {
            padding: 0;
        }


        /* ==========================================================================
           1. General - Setting up some base styles
           ========================================================================== */

        html {
            max-height: 100%;
            height: 100%;
            font-size: 62.5%;

            -webkit-tap-highlight-color: rgba(0, 0, 0, 0);
        }

        body {
            max-height: 100%;
            height: 100%;
            color: #3a4145;
            background: #f4f8fb;
            letter-spacing: 0.01rem;
            font-family: "Merriweather", serif;
            font-size: 1.8rem;
            line-height: 1.75em;
            text-rendering: geometricPrecision;

            -webkit-font-feature-settings: "kern" 1;
            -moz-font-feature-settings: "kern" 1;
            -o-font-feature-settings: "kern" 1;
        }

        ::-moz-selection {
            background: #d6edff;
        }

        ::selection {
            background: #d6edff;
        }

        h1,
        h2,
        h3,
        h4,
        h5,
        h6 {
            margin: 0 0 0.3em 0;
            color: #2e2e2e;
            font-family: "Open Sans", sans-serif;
            line-height: 1.15em;
            text-rendering: geometricPrecision;

            -webkit-font-feature-settings: "dlig" 1, "liga" 1, "lnum" 1, "kern" 1;
            -moz-font-feature-settings: "dlig" 1, "liga" 1, "lnum" 1, "kern" 1;
            -o-font-feature-settings: "dlig" 1, "liga" 1, "lnum" 1, "kern" 1;
        }

        h1 {
            text-indent: -2px;
            letter-spacing: -1px;
            font-size: 2.6rem;
        }

        h2 {
            letter-spacing: 0;
            font-size: 2.4rem;
        }

        h3 {
            letter-spacing: -0.6px;
            font-size: 2.1rem;
        }

        h4 {
            font-size: 1.9rem;
        }

        h5 {
            font-size: 1.8rem;
        }

        h6 {
            font-size: 1.8rem;
        }

        a {
            color: #4a4a4a;
        }

        a:hover {
            color: #111;
        }

        p,
        ul,
        ol,
        dl {
            margin: 0 0 2.5rem 0;
            font-size: 1.5rem;
            text-rendering: geometricPrecision;

            -webkit-font-feature-settings: "liga" 1, "onum" 1, "kern" 1;
            -moz-font-feature-settings: "liga" 1, "onum" 1, "kern" 1;
            -o-font-feature-settings: "liga" 1, "onum" 1, "kern" 1;
        }

        ol,
        ul {
            padding-left: 2em;
        }

        ol ol,
        ul ul,
        ul ol,
        ol ul {
            margin: 0 0 0.4em 0;
            padding-left: 2em;
        }

        dl dt {
            float: left;
            clear: left;
            overflow: hidden;
            margin-bottom: 1em;
            width: 180px;
            text-align: right;
            text-overflow: ellipsis;
            white-space: nowrap;
            font-weight: 700;
        }

        dl dd {
            margin-bottom: 1em;
            margin-left: 200px;
        }

        li {
            margin: 0.4em 0;
        }

        li li {
            margin: 0;
        }

        hr {
            display: block;
            margin: 1.75em 0;
            padding: 0;
            height: 1px;
            border: 0;
            border-top: #efefef 1px solid;
        }

        blockquote {
            box-sizing: border-box;
            margin: 1.75em 0 1.75em 0;
            padding: 0 0 0 1.75em;
            border-left: #4a4a4a 0.4em solid;

            -moz-box-sizing: border-box;
        }

        blockquote p {
            margin: 0.8em 0;
            font-style: italic;
        }

        blockquote small {
            display: inline-block;
            margin: 0.8em 0 0.8em 1.5em;
            color: #ccc;
            font-size: 0.9em;
        }

        blockquote small:before {
            content: "\2014 \00A0";
        }

        blockquote cite {
            font-weight: 700;
        }

        blockquote cite a {
            font-weight: normal;
        }

        mark {
            background-color: #fdffb6;
        }

        code,
        tt {
            padding: 1px 3px;
            border: #e3edf3 1px solid;
            background: #f7fafb;
            border-radius: 2px;
            white-space: pre-wrap;
            font-family: Inconsolata, monospace, sans-serif;
            font-size: 0.85em;
            font-feature-settings: "liga" 0;

            -webkit-font-feature-settings: "liga" 0;
            -moz-font-feature-settings: "liga" 0;
        }

        pre {
            overflow: auto;
            box-sizing: border-box;
            margin: 0 0 1.75em 0;
            padding: 10px;
            width: 100%;
            border: #e3edf3 1px solid;
            background: #f7fafb;
            border-radius: 3px;
            white-space: pre;
            font-family: Inconsolata, monospace, sans-serif;
            font-size: 0.9em;

            -moz-box-sizing: border-box;
        }

        pre code,
        pre tt {
            padding: 0;
            border: none;
            background: transparent;
            white-space: pre-wrap;
            font-size: inherit;
        }

        kbd {
            display: inline-block;
            margin-bottom: 0.4em;
            padding: 1px 8px;
            border: #ccc 1px solid;
            background: #f4f4f4;
            border-radius: 4px;
            box-shadow: 0 1px 0 rgba(0, 0, 0, 0.2),
            0 1px 0 0 #fff inset;
            color: #666;
            text-shadow: #fff 0 1px 0;
            font-size: 0.9em;
            font-weight: 700;
        }

        table {
            box-sizing: border-box;
            margin: 1.75em 0;
            max-width: 100%;
            width: 100%;
            background-color: transparent;

            -moz-box-sizing: border-box;
        }

        table th,
        table td {
            padding: 8px;
            border-top: #efefef 1px solid;
            vertical-align: top;
            text-align: left;
            line-height: 20px;
        }

        table th {
            color: #000;
        }

        table caption + thead tr:first-child th,
        table caption + thead tr:first-child td,
        table colgroup + thead tr:first-child th,
        table colgroup + thead tr:first-child td,
        table thead:first-child tr:first-child th,
        table thead:first-child tr:first-child td {
            border-top: 0;
        }

        table tbody + tbody {
            border-top: #efefef 2px solid;
        }

        table table table {
            background-color: #fff;
        }

        table tbody > tr:nth-child(odd) > td,
        table tbody > tr:nth-child(odd) > th {
            background-color: #f6f6f6;
        }

        table.plain tbody > tr:nth-child(odd) > td,
        table.plain tbody > tr:nth-child(odd) > th {
            background: transparent;
        }

        iframe,
        amp-iframe,
        .fluid-width-video-wrapper {
            display: block;
            margin: 1.75em 0;
        }

        /* When a video is inside the fitvids wrapper, drop the
        margin on the iframe, cause it breaks stuff. */
        .fluid-width-video-wrapper iframe,
        .fluid-width-video-wrapper amp-iframe {
            margin: 0;
        }

        textarea,
        select,
        input {
            margin: 0 0 5px 0;
            padding: 6px 9px;
            width: 260px;
            outline: 0;
            border: #e7eef2 1px solid;
            background: #fff;
            border-radius: 4px;
            box-shadow: none;
            font-family: "Open Sans", sans-serif;
            font-size: 1.6rem;
            line-height: 1.4em;
            font-weight: 100;

            -webkit-appearance: none;
        }

        textarea {
            min-width: 250px;
            min-height: 80px;
            max-width: 340px;
            width: 100%;
            height: auto;
        }

        input[type="text"]:focus,
        input[type="email"]:focus,
        input[type="search"]:focus,
        input[type="tel"]:focus,
        input[type="url"]:focus,
        input[type="password"]:focus,
        input[type="number"]:focus,
        input[type="date"]:focus,
        input[type="month"]:focus,
        input[type="week"]:focus,
        input[type="time"]:focus,
        input[type="datetime"]:focus,
        input[type="datetime-local"]:focus,
        textarea:focus {
            outline: none;
            outline-width: 0;
            border: #bbc7cc 1px solid;
            background: #fff;
        }

        select {
            width: 270px;
            height: 30px;
            line-height: 30px;
        }

        /* ==========================================================================
           2. Utilities
           ========================================================================== */

        /* Clears shit */
        .clearfix:before,
        .clearfix:after {
            content: " ";
            display: table;
        }
        .clearfix:after {
            clear: both;
        }
        .clearfix {
            zoom: 1;
        }

        /* ==========================================================================
           3. AMP Post
           ========================================================================== */



        .main-header {
            position: relative;
            display: table;
            overflow: hidden;
            box-sizing: border-box;
            width: 100%;
            height: 50px;
            background: #5ba4e5 no-repeat center center;
            background-size: cover;
            text-align: left;

            -webkit-box-sizing: border-box;
            -moz-box-sizing: border-box;
        }

        .content {
            background: #fff;
            padding-top: 15px;
        }
        .blog-title,
        .content {
            margin: auto;
            max-width: 600px;
        }

        .blog-title a {
            display: block;
            padding-right: 16px;
            padding-left: 16px;
            height: 50px;
            color: #fff;
            text-decoration: none;
            font-family: "Open Sans", sans-serif;
            font-size: 16px;
            line-height: 50px;
            font-weight: 600;
        }

        .post {
            position: relative;
            margin-top: 0;
            margin-right: 16px;
            margin-left: 16px;
            padding-bottom: 0;
            max-width: 100%;
            border-bottom: #ebf2f6 1px solid;
            word-wrap: break-word;
            font-size: 0.95em;
            line-height: 1.65em;
        }

        .post-header {
            margin-bottom: 1rem;
        }

        .post-title {
            margin-bottom: 0;
        }

        .post-title a {
            text-decoration: none;
        }

        .post-meta {
            display: block;
            margin: 3px 0 0 0;
            color: #9eabb3;
            font-family: "Open Sans", sans-serif;
            font-size: 1.3rem;
            line-height: 2.2rem;
        }

        .post-meta a {
            color: #9eabb3;
            text-decoration: none;
        }

        .post-meta a:hover {
            text-decoration: underline;
        }

        .post-meta .author {
            margin: 0;
            font-size: 1.3rem;
            line-height: 1.3em;
        }

        .post-date {
            display: inline-block;
            text-transform: uppercase;
            white-space: nowrap;
            font-size: 1.2rem;
            line-height: 1.2em;
        }

        .post-image {
            margin: 0;
            padding-top: 3rem;
            padding-bottom: 30px;
            border-top: 1px #E8E8E8 solid;
        }

        /* Keep images centered, and allow images wider than the main
           text column to break out. */
        .post-content amp-img,
        .post-content amp-anim {
            /* Centers an image by (1) pushing its left edge to the
               center of its container and (2) shifting the entire image
               in the opposite direction by half its own width.
               Works for images that are larger than their containers. */
            position: relative;
            left: 50%;
            display: block;
            padding: 0;
            min-width: 0;
            max-width: 112%; /* fallback when calc doesn't work */
            width: calc(100% + 32px); /* expand with to image + margins */
            height: auto;
            transform: translateX(-50%);

            -webkit-transform: translateX(-50%); /* for Safari and iOS */
            -ms-transform: translateX(-50%); /* for IE9 */
        }

        .footnotes {
            font-size: 1.3rem;
            line-height: 1.6em;
            font-style: italic;
        }

        .footnotes li {
            margin: 0.6rem 0;
        }

        .footnotes p {
            margin: 0;
        }

        .footnotes p a:last-child {
            text-decoration: none;
        }

        /* ==========================================================================
           4. Footer - The bottom the AMP Post
           ========================================================================== */

        .site-footer {
            position: relative;
            margin: 0 auto 20px auto;
            padding: 1rem 15px;
            max-width: 600px;
            color: rgba(0,0,0,0.5);
            font-family: "Open Sans", sans-serif;
            font-size: 1.1rem;
            line-height: 1.75em;
        }

        .site-footer a {
            color: rgba(0,0,0,0.5);
            text-decoration: none;
            font-weight: bold;
        }

        .site-footer a:hover {
            border-bottom: #bbc7cc 1px solid;
        }

        .poweredby {
            display: block;
            float: right;
            width: 45%;
            text-align: right;
        }

        .copyright {
            display: block;
            float: left;
            width: 45%;
        }
    </style>

    <style amp-boilerplate>body{-webkit-animation:-amp-start 8s steps(1,end) 0s 1 normal both;-moz-animation:-amp-start 8s steps(1,end) 0s 1 normal both;-ms-animation:-amp-start 8s steps(1,end) 0s 1 normal both;animation:-amp-start 8s steps(1,end) 0s 1 normal both}@-webkit-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@-moz-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@-ms-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@-o-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}</style><noscript><style amp-boilerplate>body{-webkit-animation:none;-moz-animation:none;-ms-animation:none;animation:none}</style></noscript>
    <script async src="https://cdn.ampproject.org/v0.js"></script>

    

</head>

<body class="amp-template">
    <header class="main-header">
        <nav class="blog-title">
            <a href="../../../../../">Lukas Nimmo</a>
        </nav>
    </header>

    <main class="content" role="main">
        <article class="post">

            <header class="post-header">
                <h1 class="post-title">How to Daemonize Rake Tasks on Ubuntu Through SSH</h1>
                <section class="post-meta">
                    <p class="author">by <a href="../../../../../author/lukas/">Lukas Nimmo</a></p>
                    <time class="post-date" datetime="2017-01-25">2017-01-25</time>
                </section>
            </header>
            <section class="post-content">

                <h2 id="daemonsandrake">Daemons and Rake</h2>

<p>At some point in your web development journey you may find yourself wanting to execute something far away from you and your terminal (think remote server). More than likely, the first thing that will enter your mind is to execute the following:</p>

<pre><code class="language-sh">$ my_rake_task
</code></pre>

<p>Easy right?</p>

<p>The problem is that once you quit your ssh connection, in other words once your remote terminal dies (developers have to sleep too), so does the process; they are "attached." </p>

<p>Next, you may think, "Well, if I can't see it then it's obviously running without me needing to be there" and you'll execute something like this:</p>

<pre><code class="language-sh">$ my_rake_task &amp;
</code></pre>

<p>The process you create is just a fork of your terminal's, so once again, as soon as you exit, so does the forked process. </p>

<p>What you could use is a daemon.</p>

<h2 id="startstopdaemon"><code>start-stop-daemon</code></h2>

<p>There is a RubyGem called <a href="https://github.com/thuehlinger/daemons">Daemons</a> which can daemonize processes within Ruby. While this may be an excellent option if a piece of Ruby code needs to be momentarily daemonized, I found the syntax to be a little confusing and did not want to add an abstraction of complexity on top of an already relatively complex subject. Also, executing something as simple as a rake task in a Ruby script requires jumping through a few hoops (again, simplicity is the goal here). For these reasons I went with <code>start-stop-daemon</code>.</p>

<p><code>start-stop-daemon</code> is an excellent tool provided by many Linux distributions to make it "easier" to control daemons. <code>start-stop-daemon</code> requires quite a few arguments and options which are necessary to get your daemon up and running. Here is an example:</p>

<pre><code class="language-sh">$ start-stop-daemon --start -m --pidfile /path/to/pidfile.pid -u $USER -d /path/to/working/dir -b --startas /path/to/script
</code></pre>

<p>Rather long, isn't it? </p>

<p>This might appear to be just-another-Linux-command-with-10-*nixillion-options-I'll-never-use-except-that-one-time-when-I-really-need-it, but this is, in fact, quite terse for what it does.</p>

<p>Let's go through some of the options and arguments:</p>

<ul>
<li><p><code>--start</code>: The easiest and clearest of them all. It kicks off the daemon.</p></li>
<li><p><code>--pidfile=PATH</code>: This is the location of the pidfile which Linux relies on to store the PID once the daemonized process begins. 
Specifying this path when trying to kill the process will also provide the PID that needs to be killed.</p></li>
<li><p><code>--m</code>: Used in tandem with the <code>--pidfile=PATH</code> option. It will create a file, if your program does not do it already, at the specified path and store the PID there.</p></li>
<li><p><code>-u USER</code>: Specify a user that the process will be owned by.</p></li>
<li><p><code>-d PATH</code>: <code>start-stop-daemon</code> will change to this directory before it executes the process. This is especially useful if oftentimes you will need to execute the process in a given directory. If this option is not provided, <code>start-stop-daemon</code> will run in the root directory.</p></li>
<li><p><code>b</code>: Or background. If your program does not detach by itself-most Ruby programs do not-then use this option.</p></li>
<li><p><code>--startas</code>: This is the <strong>executable</strong> that will run as the daemonized process. Remember to chmod your file before executing <code>start-stop-daemon</code>.</p></li>
</ul>

<p>Note: <code>start-stop-daemon</code> does <strong>nothing</strong> to monitor the process.</p>

<p>If you need more options, check out the man pages <a href="http://man7.org/linux/man-pages/man8/start-stop-daemon.8.html">here</a>, but this is enough to get going.</p>

<h2 id="theprocesshydra">The Process Hydra</h2>

<p>Here is an example script of the executable that may want to be run:</p>

<pre><code class="language-bash">#!/bin/bash
# Location: ~/awesome_task
# Executes a task that is definitely awesome

rake run_my:definitely_awesome_task  
</code></pre>

<p>And <strong><em>this</em></strong> is also the process that has its process ID stored in the path option given to <code>--pidfile</code>. </p>

<p>Catch that?</p>

<p>Let's look a little closer.</p>

<p>Suppose we are quite done with this process (as it's been running for 8 hours) and decide to kill it.</p>

<p>First we need the process:</p>

<pre><code class="language-sh">$ cat /path/to/pidfile.pid
=&gt; 9384
</code></pre>

<p>Then we try to kill it off:</p>

<pre><code class="language-sh">$ kill 9384
</code></pre>

<p>All done right? Not so fast! Let's make a quick check:</p>

<pre><code class="language-sh">$ ps aux | grep awesome_task
...
$USER 9385 10.0 38.3 304958 128399 ?      S1     08:00   8:01 ruby /path/to/bin/rake run_my:definitely_awesome_task
...
</code></pre>

<p>How can our rake task still exist??</p>

<p>There are actually two processes at play here: </p>

<ol>
<li>The bash script  </li>
<li><em>AND</em> the rake task.</li>
</ol>

<p>The rake task is executed and ran as another process whose parent process is the bash script. This means that <em>the rake task can continue running even if the bash script is killed off</em>. </p>

<p>However, this also means that if the rake task is killed, the bash script will execute the rest of its script (of which, in this example, there is nothing else) and exit. In other words, there is a chance that <em>killing off the child process very well could end the parent process</em>.</p>

<h2 id="givingdaemonslife">Giving Daemons Life</h2>

<p>There are many services out there that monitor daemons and make sure they are alive. However, if all that is required is that a task be run over and over (which was my use-case) then the following may be all you need:</p>

<pre><code class="language-bash">#!/bin/bash

while true  
do  
    rake another:definitely_awesome_task
done  
</code></pre>

<p>Unless the server crashes or some reason the process is randomly killed off then this should last for quite some time. Indefinitely, in fact.</p>

<p>Order matters in death. Remember: <strong><em>parents die first.</em></strong></p>

<p>If you want to kill off both processes, make sure to identify both processes and kill the parent first. Killing the parent first gives you the guarantee that no other process will be spawned from the rest of the execution of the script. While this may not always be the case, an infinite loop always carries the chance of executing something faster than you can ensure its death.</p>

<p>Now that the daemons are setup to be run, let's hop over the wire.</p>

<h2 id="possiblesshproblems">Possible SSH Problems</h2>

<p>There are several problems you may encounter if your code executes commands over ssh. Even if all you do is execute something as simple as:</p>

<pre><code class="language-sh">$ ssh numbluk@ip ~/bash_script_with_crazy_simple_task
</code></pre>

<p>I still recommend that you read the rest of the way through.</p>

<h4 id="strangeparsing">Strange Parsing</h4>

<p>SSH has a peculiar parsing syntax which means that sometimes it will parse things in unexpected ways. To get around this there are two steps you can follow to ensure your results are consistent with what to expect from a local shell:</p>

<ul>
<li>Prefer constructing your argument as a string first if your rake task relies on making a command over ssh</li>
<li>Always quote your commands</li>
</ul>

<p><strong>Bad</strong>: </p>

<pre><code class="language-sh">$ ssh numbluk@ip ls -alh ~/
</code></pre>

<p><strong>Good</strong>:</p>

<pre><code class="language-sh">$ ssh numbluk@ip "ls -alh ~/"
</code></pre>

<h4 id="redirectiontonowhere">Redirection to Nowhere</h4>

<p>One-time ssh commands are executed remotely, however, the output is redirected to your local shell. This means that if you rely on the output of the remotely executed command that the output must be stored in a variable if it is to be used again. </p>

<p>Always expect unexpected redirection when dealing with ssh. My recommendation is that a test should always be made locally first and then progress to making the same command over ssh.</p>

<h4 id="noteveryonesenvironment">Not Everyone's Environment</h4>

<p>If your rake task relies on environment variables at all during its execution, then you may run into a problem with ssh. </p>

<p>This problem is almost a phantom as a rake task may very well execute, but it will not execute the correct variables.</p>

<p>To get around this, do the following:</p>

<pre><code class="language-sh">$ ssh numbluk@ip
</code></pre>

<p>Open <code>/etc/ssh/sshd_config</code> and edit or add</p>

<pre><code>...
PermitUserEnvironment yes  
...
</code></pre>

<p>Next, you must specify what the ssh'd user's environment will be. To permit everything in the current ssh environment:</p>

<pre><code class="language-sh">$ env &gt;&gt; ~/.ssh/environment
</code></pre>

<p>And that should do it!</p>

<h2 id="inmemoriam">In Memoriam</h2>

<p>I want to give a big thanks to <a href="https://pdxwolfy.wordpress.com/">Pete Hanson</a>'s Linux know-how; he was an immeasurable help throughout this drawn-out process.</p>

<p>Also, thanks to <a href="http://www.michaelrmentele.com/">Michael Mentele</a> for being a superb rubber duck.</p>

            </section>

        </article>
    </main>
    <footer class="site-footer clearfix">
        <section class="copyright"><a href="../../../../../">Lukas Nimmo</a> Â© 2017</section>
        <section class="poweredby">Proudly published with <a href="https://ghost.org">Ghost</a></section>
    </footer>
</body>
